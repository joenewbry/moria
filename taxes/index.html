<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tax Prep 2025 ‚Äî CUBE</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../modules/shared.css">
  <link rel="stylesheet" href="taxes.css">
</head>
<body>

<!-- NAV -->
<nav class="back-nav">
  <div class="back-nav-inner">
    <a href="/" class="back-link"><span class="arrow">‚Üê</span> CUBE Home</a>
    <span class="nav-module-name">TAX PREP 2025</span>
  </div>
</nav>

<!-- HEADER -->
<header class="module-header">
  <span class="module-num">TX</span>
  <div class="module-label">Tax Year 2025</div>
  <h1 class="module-title">Tax Preparation Dashboard</h1>
  <p class="module-desc">
    AI-assisted tax preparation with a transparent rules engine. Upload W-2s and 1099s,
    extract data via Claude Vision, and verify compliance across Federal 1040 and California 540.
  </p>
</header>

<!-- CONTENT -->
<div class="content">

  <!-- ‚îÄ‚îÄ PIPELINE ‚îÄ‚îÄ -->
  <section class="content-section">
    <div class="section-label">Processing Pipeline</div>
    <h2 class="section-title">7-Step Pipeline</h2>
    <p class="section-desc">Each document flows through extraction, validation, and computation.</p>

    <div class="pipeline" id="pipeline">
      <div class="pipeline-step active" data-step="1">
        <div class="step-circle">1</div>
        <div class="step-label">Upload</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
      <div class="pipeline-step" data-step="2">
        <div class="step-circle">2</div>
        <div class="step-label">Vision Extract</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
      <div class="pipeline-step" data-step="3">
        <div class="step-circle">3</div>
        <div class="step-label">Validate</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
      <div class="pipeline-step" data-step="4">
        <div class="step-circle">4</div>
        <div class="step-label">Cross-Ref</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
      <div class="pipeline-step" data-step="5">
        <div class="step-circle">5</div>
        <div class="step-label">Map Fields</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
      <div class="pipeline-step" data-step="6">
        <div class="step-circle">6</div>
        <div class="step-label">Compute</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
      <div class="pipeline-step" data-step="7">
        <div class="step-circle">7</div>
        <div class="step-label">Review</div>
        <span class="step-confidence conf-none">‚Äî</span>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ READINESS + COMPLETENESS ‚îÄ‚îÄ -->
  <section class="content-section">
    <div class="two-col">
      <!-- Readiness Ring -->
      <div class="readiness" id="readiness">
        <div class="readiness-ring">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle class="ring-bg" cx="60" cy="60" r="52"/>
            <circle class="ring-fill" cx="60" cy="60" r="52"
              stroke="var(--text-muted)"
              stroke-dasharray="326.73"
              stroke-dashoffset="326.73"
              id="readiness-ring-fill"/>
          </svg>
          <div class="readiness-pct" id="readiness-pct">0%</div>
        </div>
        <div class="readiness-title">Filing Readiness</div>
        <div class="readiness-subtitle">Upload documents to begin</div>
      </div>

      <!-- Completeness Tracker -->
      <div>
        <div class="section-label">Completeness</div>
        <h2 class="section-title" style="margin-bottom:24px">Tracker</h2>

        <div class="completeness-bar-wrap">
          <div class="completeness-label">
            <span class="cl-name">Document Collection</span>
            <span class="cl-pct" id="comp-docs">0%</span>
          </div>
          <div class="completeness-bar">
            <div class="completeness-fill low" id="comp-docs-bar" style="width:0%"></div>
          </div>
        </div>

        <div class="completeness-bar-wrap">
          <div class="completeness-label">
            <span class="cl-name">Field Extraction</span>
            <span class="cl-pct" id="comp-fields">0%</span>
          </div>
          <div class="completeness-bar">
            <div class="completeness-fill low" id="comp-fields-bar" style="width:0%"></div>
          </div>
        </div>

        <div class="completeness-bar-wrap">
          <div class="completeness-label">
            <span class="cl-name">Cross-Validation</span>
            <span class="cl-pct" id="comp-xval">0%</span>
          </div>
          <div class="completeness-bar">
            <div class="completeness-fill low" id="comp-xval-bar" style="width:0%"></div>
          </div>
        </div>

        <div class="completeness-bar-wrap">
          <div class="completeness-label">
            <span class="cl-name">Compliance Checks</span>
            <span class="cl-pct" id="comp-forms">0%</span>
          </div>
          <div class="completeness-bar">
            <div class="completeness-fill low" id="comp-forms-bar" style="width:0%"></div>
          </div>
        </div>

        <div class="completeness-bar-wrap">
          <div class="completeness-label">
            <span class="cl-name">Human Review</span>
            <span class="cl-pct" id="comp-review">0%</span>
          </div>
          <div class="completeness-bar">
            <div class="completeness-fill low" id="comp-review-bar" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ UPLOAD SECTION ‚îÄ‚îÄ -->
  <section class="content-section">
    <div class="section-label">Documents</div>
    <h2 class="section-title">Upload W-2s &amp; 1099s</h2>
    <p class="section-desc">Drop tax documents here. Claude Vision will extract and validate fields automatically.</p>

    <div class="upload-zone" id="upload-zone">
      <input type="file" id="file-input" multiple accept=".pdf,.png,.jpg,.jpeg">
      <div class="upload-icon">üìÑ</div>
      <div class="upload-title">Drop documents here or click to browse</div>
      <div class="upload-hint">Supports PDF, PNG, JPG ‚Äî W-2, 1099-NEC, 1099-INT, 1099-DIV</div>
    </div>

    <div class="doc-list" id="doc-list"></div>
  </section>

  <!-- ‚îÄ‚îÄ PROCESSING LOG ‚îÄ‚îÄ -->
  <section class="content-section" id="processing-section" style="display:none">
    <div class="section-label">Claude Vision</div>
    <h2 class="section-title">Processing Log</h2>
    <p class="section-desc">Real-time narrative from Claude as it analyzes your documents.</p>

    <div class="processing-log" id="processing-log">
      <div class="log-entries" id="log-entries"></div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ INCOME SOURCES ‚îÄ‚îÄ -->
  <section class="content-section">
    <div class="section-label">Income</div>
    <h2 class="section-title">Income Sources</h2>
    <p class="section-desc">All W-2 and 1099 income aggregated from extracted documents.</p>

    <div id="income-sources">
      <div class="tax-section-card" style="text-align:center;padding:48px">
        <div style="font-size:32px;margin-bottom:12px;opacity:0.4">üìä</div>
        <div style="color:var(--text-muted);font-size:14px">Upload documents to populate income sources</div>
      </div>
    </div>

    <!-- Summary row (hidden until data) -->
    <div class="stat-row" id="income-summary" style="display:none">
      <div class="stat-box">
        <div class="stat-num" id="total-w2">$0</div>
        <div class="stat-label">W-2 Wages</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="total-1099">$0</div>
        <div class="stat-label">1099 Income</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="total-gross">$0</div>
        <div class="stat-label">Total Gross</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="total-withheld">$0</div>
        <div class="stat-label">Total Withheld</div>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ FILING OVERVIEW ‚îÄ‚îÄ -->
  <section class="content-section">
    <div class="section-label">Filing</div>
    <h2 class="section-title">Filing Overview</h2>
    <p class="section-desc">Federal Form 1040 and California Form 540. Values computed from uploaded documents.</p>

    <div class="filing-grid">
      <!-- Federal 1040 -->
      <div class="filing-card federal">
        <div class="filing-label">Federal ‚Äî Form 1040</div>
        <div class="filing-row">
          <span class="label">Total Income (Line 9)</span>
          <span class="value pending" id="fed-income">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">Adjustments (Sch 1)</span>
          <span class="value pending" id="fed-adj">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">AGI (Line 11)</span>
          <span class="value pending" id="fed-agi">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">Deduction</span>
          <span class="value pending" id="fed-deduction">Standard</span>
        </div>
        <div class="filing-row">
          <span class="label">Taxable Income (Line 15)</span>
          <span class="value pending" id="fed-taxable">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">Tax (Line 16)</span>
          <span class="value pending" id="fed-tax">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">Total Payments</span>
          <span class="value pending" id="fed-payments">‚Äî</span>
        </div>
        <div class="filing-row" style="border-bottom:none;padding-top:12px">
          <span class="label" style="font-weight:600;color:var(--text)">Refund / Owed</span>
          <span class="value pending" id="fed-result" style="font-size:16px">‚Äî</span>
        </div>
      </div>

      <!-- California 540 -->
      <div class="filing-card state">
        <div class="filing-label">California ‚Äî Form 540</div>
        <div class="filing-row">
          <span class="label">Federal AGI</span>
          <span class="value pending" id="ca-agi">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">CA Adjustments</span>
          <span class="value pending" id="ca-adj">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">CA Taxable Income</span>
          <span class="value pending" id="ca-taxable">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">CA Tax</span>
          <span class="value pending" id="ca-tax">‚Äî</span>
        </div>
        <div class="filing-row">
          <span class="label">CA Withholding</span>
          <span class="value pending" id="ca-withheld">‚Äî</span>
        </div>
        <div class="filing-row" style="border-bottom:none;padding-top:12px">
          <span class="label" style="font-weight:600;color:var(--text)">Refund / Owed</span>
          <span class="value pending" id="ca-result" style="font-size:16px">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ RULES ENGINE SUMMARY ‚îÄ‚îÄ -->
  <section class="content-section" id="compliance-section" style="display:none">
    <div class="section-label">Rules Engine</div>
    <h2 class="section-title">Two Guarantees</h2>
    <p class="section-desc">Transparent rules mapped to real tax code. Every check is auditable.</p>

    <div class="guarantee-grid" id="guarantee-grid">
      <div class="guarantee-card compliance-guarantee">
        <div class="guarantee-icon">&#x1F6E1;</div>
        <div class="guarantee-title">Audit Shield</div>
        <div class="guarantee-desc">If you're honest, you won't get audited</div>
        <div class="guarantee-stats">
          <span class="guarantee-num" id="comp-passed">0</span>
          <span class="guarantee-label">compliance checks passed</span>
        </div>
        <div class="guarantee-detail">
          <span class="guarantee-detail-item warn-count"><span id="comp-warnings">0</span> warnings</span>
          <span class="guarantee-detail-item fail-count"><span id="comp-failed">0</span> failed</span>
        </div>
      </div>
      <div class="guarantee-card savings-guarantee">
        <div class="guarantee-icon">&#x1F50D;</div>
        <div class="guarantee-title">Savings Finder</div>
        <div class="guarantee-desc">We check every deduction you qualify for</div>
        <div class="guarantee-stats">
          <span class="guarantee-num" id="savings-opportunities">0</span>
          <span class="guarantee-label">savings opportunities found</span>
        </div>
        <div class="guarantee-detail">
          <span class="guarantee-detail-item eval-count"><span id="savings-evaluated">0</span> evaluated</span>
          <span class="guarantee-detail-item skip-count"><span id="savings-skipped">0</span> skipped</span>
        </div>
      </div>
    </div>

    <div class="compliance-score-row">
      <div class="compliance-score-bar">
        <div class="compliance-score-fill" id="comp-score-fill" style="width:0%"></div>
      </div>
      <span class="compliance-score-label" id="comp-score-label">0%</span>
    </div>

    <a href="rules.html" class="compliance-link">View all rules with tax code citations ‚Üí</a>
  </section>

  <!-- ‚îÄ‚îÄ APPROACH ‚îÄ‚îÄ -->
  <section class="content-section">
    <div class="section-label">Methodology</div>
    <h2 class="section-title">Our Approach</h2>

    <div class="phase-grid">
      <div class="phase-card">
        <div class="phase-num">01</div>
        <h3>Rules Engine</h3>
        <p>69 rules across 4 scenarios and 6 stages. Every rule cites real IRC/RTC sections. Compliance checks + savings optimization in one engine.</p>
      </div>
      <div class="phase-card">
        <div class="phase-num">02</div>
        <h3>Binary Extraction</h3>
        <p>Each field is either extracted or not ‚Äî no ambiguous confidence scores. Clear checkmarks show what we got, warnings show what's missing.</p>
      </div>
      <div class="phase-card">
        <div class="phase-num">03</div>
        <h3>Claude Vision OCR</h3>
        <p>Semantic document understanding, not just character recognition. Handles varied W-2 layouts. Extracts structured field‚Üívalue mappings.</p>
      </div>
      <div class="phase-card">
        <div class="phase-num">04</div>
        <h3>Two Guarantees</h3>
        <p>Audit Shield verifies compliance with IRS/CA rules. Savings Finder checks every deduction and credit you qualify for.</p>
      </div>
    </div>

    <p style="margin-top:24px;font-size:13px;color:var(--text-muted)">
      Full methodology: <a href="approach.md" style="color:var(--teal);text-decoration:none">approach.md</a>
    </p>
  </section>

  <!-- DISCLAIMER -->
  <div class="disclaimer">
    <strong>Disclaimer</strong>
    This is a tax preparation assistance tool, not professional tax advice. All extracted values should be
    verified against original documents before filing. Consult a qualified tax professional for complex
    tax situations. This tool does not e-file ‚Äî it generates completed forms for your review.
  </div>

</div>

<!-- FOOTER -->
<footer class="module-footer">
  <div class="footer-brand">CUBE √ó TAX PREP</div>
  <div class="footer-right">Tax Year 2025 ¬∑ <a href="approach.md">Methodology</a></div>
</footer>

<div class="noise-overlay"></div>

<script src="rules.js"></script>
<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const state = {
  documents: [],
  incomes: [],
  pipeline: { current: 1, steps: {} },
  completeness: { docs: 0, fields: 0, xval: 0, forms: 0, review: 0 },
  filing: null
};

const API_BASE = '/taxes/api';

// ‚îÄ‚îÄ UPLOAD HANDLING ‚îÄ‚îÄ
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');

['dragenter', 'dragover'].forEach(e => {
  uploadZone.addEventListener(e, ev => { ev.preventDefault(); uploadZone.classList.add('dragover'); });
});
['dragleave', 'drop'].forEach(e => {
  uploadZone.addEventListener(e, ev => { ev.preventDefault(); uploadZone.classList.remove('dragover'); });
});

uploadZone.addEventListener('drop', e => {
  const files = Array.from(e.dataTransfer.files);
  handleFiles(files);
});

fileInput.addEventListener('change', e => {
  handleFiles(Array.from(e.target.files));
  e.target.value = '';
});

function handleFiles(files) {
  files.forEach(file => {
    const doc = {
      id: crypto.randomUUID(),
      name: file.name,
      size: file.size,
      type: guessDocType(file.name),
      status: 'uploading',
      extractionStatus: {},
      file: file
    };
    state.documents.push(doc);
    renderDocList();
    processDocument(doc);
  });
}

function guessDocType(name) {
  const lower = name.toLowerCase();
  if (lower.includes('w-2') || lower.includes('w2')) return 'W-2';
  if (lower.includes('1099-nec') || lower.includes('1099nec')) return '1099-NEC';
  if (lower.includes('1099-int')) return '1099-INT';
  if (lower.includes('1099-div')) return '1099-DIV';
  if (lower.includes('1099')) return '1099';
  return 'Unknown';
}

function renderDocList() {
  const list = document.getElementById('doc-list');
  list.innerHTML = state.documents.map(doc => {
    const iconClass = doc.type.startsWith('W-2') ? 'w2' : 'nec';
    let statusHtml;
    if (doc.status === 'uploading') {
      statusHtml = '<span class="step-confidence conf-none"><span class="spinner"></span> Uploading‚Ä¶</span>';
    } else if (doc.status === 'processing') {
      statusHtml = '<span class="step-confidence conf-none"><span class="spinner"></span> Analyzing‚Ä¶</span>';
    } else if (doc.status === 'processed') {
      // Binary: all fields extracted ‚Üí checkmark, some missing ‚Üí warning
      const exStatus = doc.extractionStatus || {};
      const fields = Object.values(exStatus);
      const missing = fields.filter(v => v === 'not_found').length;
      if (missing > 0) {
        statusHtml = `<span class="step-confidence conf-medium">‚ö† ${fields.length - missing}/${fields.length}</span>`;
      } else {
        statusHtml = '<span class="step-confidence conf-high">‚úì Extracted</span>';
      }
    } else if (doc.status === 'error') {
      statusHtml = '<span class="step-confidence conf-low">Error</span>';
    } else {
      statusHtml = '<span class="step-confidence conf-none">‚Äî</span>';
    }
    return `
      <div class="doc-item">
        <div class="doc-icon ${iconClass}">${doc.type.startsWith('W') ? 'W' : '#'}</div>
        <div class="doc-info">
          <div class="doc-name">${doc.name}</div>
          <div class="doc-meta">${doc.type} ¬∑ ${formatSize(doc.size)}</div>
        </div>
        <div class="doc-status">${statusHtml}</div>
      </div>`;
  }).join('');
}

function confClass(score) {
  if (score >= 0.95) return 'conf-high';
  if (score >= 0.80) return 'conf-medium';
  return 'conf-low';
}

function completenessClass(pct) {
  if (pct >= 95) return 'high';
  if (pct >= 80) return 'medium';
  return 'low';
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

function formatCurrency(n) {
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

// ‚îÄ‚îÄ PROCESSING LOG ‚îÄ‚îÄ
function showProcessingLog() {
  document.getElementById('processing-section').style.display = '';
}

function addLogEntry(text, docName) {
  const entries = document.getElementById('log-entries');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  if (docName) {
    const label = document.createElement('span');
    label.className = 'log-doc-label';
    label.textContent = docName;
    entry.appendChild(label);
  }
  const content = document.createElement('div');
  content.className = 'log-text';
  content.textContent = text;
  entry.appendChild(content);
  entries.appendChild(entry);
  // Scroll to bottom
  const log = document.getElementById('processing-log');
  log.scrollTop = log.scrollHeight;
  // Animate in
  requestAnimationFrame(() => entry.classList.add('visible'));
}

function addLogDivider() {
  const entries = document.getElementById('log-entries');
  const divider = document.createElement('div');
  divider.className = 'log-divider';
  entries.appendChild(divider);
}

// ‚îÄ‚îÄ REAL API PROCESSING ‚îÄ‚îÄ
async function processDocument(doc) {
  showProcessingLog();
  updatePipelineStep(1, 'active');
  addLogEntry(`Uploading ${doc.name}‚Ä¶`, doc.name);

  doc.status = 'uploading';
  renderDocList();

  const formData = new FormData();
  formData.append('file', doc.file);

  try {
    updatePipelineStep(1, 'done');
    updatePipelineStep(2, 'active');
    doc.status = 'processing';
    renderDocList();
    addLogEntry('Sending to Claude Vision for analysis‚Ä¶', doc.name);

    const response = await fetch(`${API_BASE}/extract`, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      throw new Error(`Server returned ${response.status}: ${response.statusText}`);
    }

    // Read SSE stream
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let extractedData = null;
    let logCount = 0;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });

      // Parse SSE events from buffer
      const lines = buffer.split('\n');
      buffer = lines.pop(); // Keep incomplete line in buffer

      let eventType = null;
      let eventData = '';

      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ')) {
          eventData = line.slice(6);
          if (eventType && eventData) {
            try {
              const parsed = JSON.parse(eventData);
              if (eventType === 'log') {
                logCount++;
                addLogEntry(parsed.text, doc.name);
                // Advance pipeline based on log progress
                if (logCount === 1) { updatePipelineStep(2, 'active'); }
                if (logCount === 2) { updatePipelineStep(2, 'done'); updatePipelineStep(3, 'active'); }
                if (logCount === 3) { updatePipelineStep(3, 'done'); updatePipelineStep(4, 'active'); }
                if (logCount === 4) { updatePipelineStep(4, 'done'); updatePipelineStep(5, 'active'); }
              } else if (eventType === 'data') {
                extractedData = parsed;
                updatePipelineStep(5, 'done');
                updatePipelineStep(6, 'active');
                const exStatus = parsed.extraction_status || {};
                const exFields = Object.values(exStatus);
                const exCount = exFields.filter(v => v === 'extracted').length;
                addLogEntry(`Extracted ${parsed.doc_type || 'document'} data ‚Äî ${exCount}/${exFields.length} fields found.`, doc.name);
              } else if (eventType === 'error') {
                addLogEntry(`Error: ${parsed.error}`, doc.name);
                doc.status = 'error';
                renderDocList();
              } else if (eventType === 'done') {
                updatePipelineStep(6, 'done');
                updatePipelineStep(7, 'active');
              }
            } catch (e) {
              // Skip malformed JSON
            }
            eventType = null;
            eventData = '';
          }
        } else if (line === '') {
          eventType = null;
          eventData = '';
        }
      }
    }

    if (extractedData) {
      doc.status = 'processed';
      doc.extractionStatus = extractedData.extraction_status || {};

      // Use doc_type from extraction if we guessed wrong
      if (extractedData.doc_type) {
        doc.type = extractedData.doc_type;
      }

      state.incomes.push(extractedData);
      renderDocList();
      renderIncomes();
      updateCompleteness();
      updateFilingOverview();
      runCompliance();
      updatePipelineStep(7, 'done');
      addLogDivider();
    } else if (doc.status !== 'error') {
      doc.status = 'error';
      addLogEntry('No structured data received from API.', doc.name);
      renderDocList();
    }

  } catch (error) {
    doc.status = 'error';
    addLogEntry(`Error: ${error.message}`, doc.name);
    renderDocList();
    console.error('Processing error:', error);
  }
}

// ‚îÄ‚îÄ PIPELINE UI ‚îÄ‚îÄ
function updatePipelineStep(step, status) {
  const pipelineEl = document.getElementById('pipeline');
  const allSteps = pipelineEl.querySelectorAll('.pipeline-step');

  allSteps.forEach((el, i) => {
    const sn = i + 1;
    if (sn < step) {
      el.className = 'pipeline-step done';
      const conf = el.querySelector('.step-confidence');
      if (conf.textContent === '‚Äî' || conf.textContent === '‚Ä¶') {
        conf.className = 'step-confidence conf-high';
        conf.textContent = '‚úì';
      }
    } else if (sn === step) {
      if (status === 'done') {
        el.className = 'pipeline-step done';
        const conf = el.querySelector('.step-confidence');
        conf.className = 'step-confidence conf-high';
        conf.textContent = '‚úì';
      } else {
        el.className = 'pipeline-step active';
        el.querySelector('.step-confidence').className = 'step-confidence conf-none';
        el.querySelector('.step-confidence').textContent = '‚Ä¶';
      }
    }
  });
}

// ‚îÄ‚îÄ INCOME RENDERING ‚îÄ‚îÄ
function renderIncomes() {
  const container = document.getElementById('income-sources');
  if (state.incomes.length === 0) return;

  container.innerHTML = state.incomes.map(inc => {
    const exStatus = inc.extraction_status || {};
    const fields = Object.values(exStatus);
    const extracted = fields.filter(v => v === 'extracted').length;
    const total = fields.length;
    const allExtracted = total > 0 && extracted === total;
    const statusBadge = allExtracted
      ? '<span class="step-confidence conf-high">‚úì All fields extracted</span>'
      : total > 0
        ? `<span class="step-confidence conf-medium">‚ö† ${extracted}/${total} fields</span>`
        : '<span class="step-confidence conf-high">‚úì Extracted</span>';

    if (inc.doc_type === 'W-2') {
      const employer = inc.employer_name || 'Unknown Employer';
      return `
        <div class="income-card">
          <div class="income-header">
            <div class="income-type">
              <span class="type-badge w2">W-2</span>
              <span class="income-employer">${employer}</span>
            </div>
            <span class="income-amount">${formatCurrency(inc.wages || 0)}</span>
          </div>
          <div class="income-details">
            <div class="income-detail"><span class="dl">Fed Withheld</span><span class="dv">${formatCurrency(inc.fed_income_tax_withheld || 0)}</span></div>
            <div class="income-detail"><span class="dl">State Withheld</span><span class="dv">${formatCurrency(inc.state_income_tax_withheld || 0)}</span></div>
            <div class="income-detail"><span class="dl">SS Tax</span><span class="dv">${formatCurrency(inc.social_security_tax_withheld || 0)}</span></div>
            <div class="income-detail"><span class="dl">Medicare Tax</span><span class="dv">${formatCurrency(inc.medicare_tax_withheld || 0)}</span></div>
          </div>
          <div style="margin-top:10px;text-align:right">
            ${statusBadge}
          </div>
        </div>`;
    } else {
      const payer = inc.payer_name || 'Unknown Payer';
      const amount = inc.nonemployee_compensation || inc.interest_income || inc.ordinary_dividends || 0;
      const docType = inc.doc_type || 'Unknown';
      return `
        <div class="income-card">
          <div class="income-header">
            <div class="income-type">
              <span class="type-badge nec">${docType}</span>
              <span class="income-employer">${payer}</span>
            </div>
            <span class="income-amount">${formatCurrency(amount)}</span>
          </div>
          <div class="income-details">
            ${inc.fed_income_tax_withheld ? `<div class="income-detail"><span class="dl">Fed Withheld</span><span class="dv">${formatCurrency(inc.fed_income_tax_withheld)}</span></div>` : ''}
            ${inc.state_tax_withheld ? `<div class="income-detail"><span class="dl">State Withheld</span><span class="dv">${formatCurrency(inc.state_tax_withheld)}</span></div>` : ''}
            ${inc.qualified_dividends != null ? `<div class="income-detail"><span class="dl">Qualified Div</span><span class="dv">${formatCurrency(inc.qualified_dividends)}</span></div>` : ''}
          </div>
          <div style="margin-top:10px;text-align:right">
            ${statusBadge}
          </div>
        </div>`;
    }
  }).join('');

  // Summary
  const totalW2 = state.incomes.filter(i => i.doc_type === 'W-2').reduce((s, i) => s + (i.wages || 0), 0);
  const total1099 = state.incomes.filter(i => i.doc_type !== 'W-2').reduce((s, i) => s + (i.nonemployee_compensation || i.interest_income || i.ordinary_dividends || 0), 0);
  const totalWithheld = state.incomes.reduce((s, i) => s + (i.fed_income_tax_withheld || 0), 0);

  document.getElementById('total-w2').textContent = formatCurrency(totalW2);
  document.getElementById('total-1099').textContent = formatCurrency(total1099);
  document.getElementById('total-gross').textContent = formatCurrency(totalW2 + total1099);
  document.getElementById('total-withheld').textContent = formatCurrency(totalWithheld);
  document.getElementById('income-summary').style.display = '';
}

function updateCompleteness() {
  const n = state.documents.filter(d => d.status === 'processed').length;
  const total = Math.max(n, 2);

  // Field extraction: count extracted vs total fields across all incomes
  let totalFields = 0, extractedFields = 0;
  state.incomes.forEach(i => {
    const exStatus = i.extraction_status || {};
    const vals = Object.values(exStatus);
    totalFields += vals.length;
    extractedFields += vals.filter(v => v === 'extracted').length;
  });
  const fieldPct = totalFields > 0 ? Math.round((extractedFields / totalFields) * 100) : 0;

  const c = {
    docs: Math.min(100, Math.round((n / total) * 100)),
    fields: fieldPct,
    xval: n > 1 ? 85 : (n > 0 ? 40 : 0),
    forms: 0,  // Will be set by rules engine
    review: 0
  };
  state.completeness = c;

  ['docs', 'fields', 'xval', 'forms', 'review'].forEach(key => {
    const pct = c[key];
    document.getElementById('comp-' + key).textContent = pct + '%';
    const bar = document.getElementById('comp-' + key + '-bar');
    bar.style.width = pct + '%';
    bar.className = 'completeness-fill ' + completenessClass(pct);
  });

  const avg = Math.round((c.docs + c.fields + c.xval + c.forms + c.review) / 5);
  updateReadiness(avg);
}

function updateReadiness(pct) {
  const circumference = 2 * Math.PI * 52;
  const offset = circumference - (pct / 100) * circumference;
  const fill = document.getElementById('readiness-ring-fill');
  const color = pct >= 95 ? 'var(--accent)' : pct >= 80 ? 'var(--orange)' : pct >= 50 ? 'var(--blue)' : 'var(--text-muted)';
  fill.setAttribute('stroke', color);
  fill.setAttribute('stroke-dashoffset', offset);
  document.getElementById('readiness-pct').textContent = pct + '%';
  document.getElementById('readiness-pct').style.color = color;
}

function updateFilingOverview() {
  const totalW2 = state.incomes.filter(i => i.doc_type === 'W-2').reduce((s, i) => s + (i.wages || 0), 0);
  const totalNEC = state.incomes.filter(i => i.doc_type === '1099-NEC').reduce((s, i) => s + (i.nonemployee_compensation || 0), 0);
  const totalINT = state.incomes.filter(i => i.doc_type === '1099-INT').reduce((s, i) => s + (i.interest_income || 0), 0);
  const totalDIV = state.incomes.filter(i => i.doc_type === '1099-DIV').reduce((s, i) => s + (i.ordinary_dividends || 0), 0);
  const totalIncome = totalW2 + totalNEC + totalINT + totalDIV;

  const seTaxableIncome = totalNEC * 0.9235;
  const seTax = Math.round(seTaxableIncome * 0.153);
  const seDeduction = Math.floor(seTax * 0.5);
  const adjustments = seDeduction;
  const agi = totalIncome - adjustments;
  const standardDeduction = 15000;
  const taxableIncome = Math.max(0, agi - standardDeduction);
  const fedIncomeTax = computeFederalTax(taxableIncome);
  const totalFedTax = fedIncomeTax + seTax;
  const totalFedWithheld = state.incomes.reduce((s, i) => s + (i.fed_income_tax_withheld || 0), 0);
  const fedResult = totalFedWithheld - totalFedTax;

  setVal('fed-income', formatCurrency(totalIncome));
  setVal('fed-adj', adjustments > 0 ? '‚àí' + formatCurrency(adjustments) : '$0');
  setVal('fed-agi', formatCurrency(agi));
  setVal('fed-deduction', 'Standard ($15,000)');
  setVal('fed-taxable', formatCurrency(taxableIncome));
  setVal('fed-tax', formatCurrency(totalFedTax));
  setVal('fed-payments', formatCurrency(totalFedWithheld));
  const fedEl = document.getElementById('fed-result');
  fedEl.textContent = fedResult >= 0 ? '+' + formatCurrency(fedResult) : '‚àí' + formatCurrency(Math.abs(fedResult));
  fedEl.className = 'value ' + (fedResult >= 0 ? 'refund' : 'owed');

  // California
  const caStdDeduction = 5540;
  const caTaxable = Math.max(0, agi - caStdDeduction);
  const caTax = computeCaliforniaTax(caTaxable);
  const totalStateWithheld = state.incomes.reduce((s, i) => s + (i.state_income_tax_withheld || i.state_tax_withheld || 0), 0);
  const caResult = totalStateWithheld - caTax;

  setVal('ca-agi', formatCurrency(agi));
  setVal('ca-adj', '$0');
  setVal('ca-taxable', formatCurrency(caTaxable));
  setVal('ca-tax', formatCurrency(caTax));
  setVal('ca-withheld', formatCurrency(totalStateWithheld));
  const caEl = document.getElementById('ca-result');
  caEl.textContent = caResult >= 0 ? '+' + formatCurrency(caResult) : '‚àí' + formatCurrency(Math.abs(caResult));
  caEl.className = 'value ' + (caResult >= 0 ? 'refund' : 'owed');

  // Store filing state for compliance
  state.filing = {
    filingStatus: 'Single',
    totalW2Wages: totalW2,
    totalIncome,
    adjustments,
    agi,
    standardDeduction,
    taxableIncome,
    fedIncomeTax,
    seTax,
    totalFedTax,
    totalFedWithheld,
    fedResult,
    caTaxableIncome: caTaxable,
    caTax,
    totalStateWithheld,
    caResult
  };
}

function setVal(id, text) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.classList.remove('pending');
}

// 2025 Federal brackets (single)
function computeFederalTax(taxable) {
  const brackets = [
    [11925, 0.10], [48475 - 11925, 0.12], [103350 - 48475, 0.22],
    [197300 - 103350, 0.24], [250525 - 197300, 0.32],
    [626350 - 250525, 0.35], [Infinity, 0.37]
  ];
  let tax = 0, remaining = taxable;
  for (const [width, rate] of brackets) {
    if (remaining <= 0) break;
    const amount = Math.min(remaining, width);
    tax += amount * rate;
    remaining -= amount;
  }
  return Math.round(tax);
}

// 2025 California brackets (single)
function computeCaliforniaTax(taxable) {
  const brackets = [
    [10412, 0.01], [24684 - 10412, 0.02], [38959 - 24684, 0.04],
    [54081 - 38959, 0.06], [68350 - 54081, 0.08],
    [349137 - 68350, 0.093], [418961 - 349137, 0.103],
    [698271 - 418961, 0.113], [Infinity, 0.123]
  ];
  let tax = 0, remaining = taxable;
  for (const [width, rate] of brackets) {
    if (remaining <= 0) break;
    const amount = Math.min(remaining, width);
    tax += amount * rate;
    remaining -= amount;
  }
  if (taxable > 1000000) {
    tax += (taxable - 1000000) * 0.01;
  }
  return Math.round(tax);
}

// ‚îÄ‚îÄ RULES ENGINE ‚îÄ‚îÄ
function runCompliance() {
  if (typeof runRulesEngine !== 'function') return;

  const rulesState = {
    documents: state.documents,
    incomes: state.incomes,
    filing: state.filing
  };

  const { results, summary, complianceSummary, savingsSummary, stages, scenarios } = runRulesEngine(rulesState);

  // Show rules section
  document.getElementById('compliance-section').style.display = '';

  // Compliance guarantee card
  document.getElementById('comp-passed').textContent = complianceSummary.passed;
  document.getElementById('comp-failed').textContent = complianceSummary.failed;
  document.getElementById('comp-warnings').textContent = complianceSummary.warnings;

  // Savings guarantee card
  document.getElementById('savings-opportunities').textContent = savingsSummary.opportunities;
  document.getElementById('savings-evaluated').textContent = savingsSummary.evaluated;
  document.getElementById('savings-skipped').textContent = savingsSummary.skipped;

  // Score bar (compliance score)
  const scoreFill = document.getElementById('comp-score-fill');
  const scoreLabel = document.getElementById('comp-score-label');
  scoreFill.style.width = complianceSummary.score + '%';
  scoreLabel.textContent = complianceSummary.score + '%';

  if (complianceSummary.score >= 90) {
    scoreFill.style.background = 'var(--accent)';
  } else if (complianceSummary.score >= 70) {
    scoreFill.style.background = 'var(--orange)';
  } else {
    scoreFill.style.background = 'var(--warn)';
  }

  // Update completeness
  state.completeness.forms = complianceSummary.score;
  document.getElementById('comp-forms').textContent = complianceSummary.score + '%';
  const formsBar = document.getElementById('comp-forms-bar');
  formsBar.style.width = complianceSummary.score + '%';
  formsBar.className = 'completeness-fill ' + completenessClass(complianceSummary.score);

  // Recalculate readiness
  const c = state.completeness;
  const avg = Math.round((c.docs + c.fields + c.xval + c.forms + c.review) / 5);
  updateReadiness(avg);

  // Save to localStorage for rules.html and checks.html (backward compat)
  try {
    // New format for rules.html
    localStorage.setItem('taxRulesResults', JSON.stringify({
      results, summary, complianceSummary, savingsSummary, stages, scenarios, timestamp: Date.now()
    }));
    // Backward compat for checks.html
    const categories = stages.map(st => ({ id: st.id, name: st.name, icon: st.icon, description: `Stage ${st.num}: ${st.name}` }));
    const mappedResults = results.map(r => ({
      ...r, category: r.stage,
      irsRef: r.taxCode ? `${r.taxCode.section} ¬∑ ${r.taxCode.form} ${r.taxCode.line}` : 'General',
      description: r.detail || '', confidence: r.extracted ? 1.0 : 0.0,
    }));
    localStorage.setItem('taxComplianceResults', JSON.stringify({ results: mappedResults, summary, categories, timestamp: Date.now() }));
    localStorage.setItem('taxState', JSON.stringify(rulesState));
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}
</script>
</body>
</html>
